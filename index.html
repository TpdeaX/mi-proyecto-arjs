<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ar-js-org/ar.js/aframe/build/aframe-ar-nft.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
      }
      #camera-selector {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.8);
        padding: 10px;
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <!-- Selector de cámara -->
    <div id="camera-selector">
      <label for="camera-select">Selecciona la cámara:</label>
      <select id="camera-select">
        <option value="rear">Cámara trasera</option>
        <option value="front">Cámara frontal</option>
      </select>
    </div>

    <a-scene
      embedded
      loading-screen="enabled: false;"
      arjs="sourceType: webcam; debugUIEnabled: false;"
    >
      <a-assets timeout="10000" id="assets-container">
        <!-- Los modelos se cargarán dinámicamente aquí -->
      </a-assets>
      <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>

    <script>
      // Función para cargar los modelos
      async function loadModels() {
        try {
          const response = await fetch("models.json");
          const models = await response.json();
          const assetsContainer = document.querySelector("#assets-container");
          const scene = document.querySelector("a-scene");

          models.forEach((item) => {
            const asset = document.createElement("a-asset-item");
            asset.setAttribute("id", item.id);
            asset.setAttribute("src", item.src);
            assetsContainer.appendChild(asset);

            const entity = document.createElement("a-entity");
            entity.setAttribute("gltf-model", `#${item.id}`);
            entity.setAttribute(
              "gps-entity-place",
              `latitude: ${item.latitude}; longitude: ${item.longitude};`
            );
            entity.setAttribute("scale", item.scale);
            scene.appendChild(entity);
          });
        } catch (error) {
          console.error("Error al cargar los modelos:", error);
        }
      }

      // Función para manejar el cambio de cámara
      function handleCameraChange() {
        const cameraSelect = document.getElementById("camera-select");
        const selectedCamera = cameraSelect.value;

        // Guardar la selección en localStorage para mantenerla después de la recarga
        localStorage.setItem("selectedCamera", selectedCamera);

        // Recargar la página con el parámetro de cámara en la URL
        window.location.search = `?camera=${selectedCamera}`;
      }

      // Obtener la cámara seleccionada de la URL o localStorage
      function getSelectedCamera() {
        const urlParams = new URLSearchParams(window.location.search);
        const cameraFromUrl = urlParams.get("camera");
        if (cameraFromUrl) {
          return cameraFromUrl;
        }
        return localStorage.getItem("selectedCamera") || "rear"; // Valor predeterminado: "rear"
      }

      // Configurar AR.js con la cámara seleccionada
      function setupARJS() {
        const selectedCamera = getSelectedCamera();
        const arjsSystem = document.querySelector("a-scene").systems.arjs;

        // Establecer la cámara en AR.js
        if (selectedCamera === "front") {
          arjsSystem.arSessionSettings.cameraDirection = "FRONT";
        } else {
          arjsSystem.arSessionSettings.cameraDirection = "BACK";
        }

        // Actualizar el combobox con la cámara seleccionada
        const cameraSelect = document.getElementById("camera-select");
        cameraSelect.value = selectedCamera;

        // Escuchar cambios en el combobox
        cameraSelect.addEventListener("change", handleCameraChange);
      }

      // Inicializar la aplicación
      window.onload = () => {
        loadModels();
        setupARJS();
      };
    </script>
  </body>
</html>
