<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ar-js-org/ar.js/aframe/build/aframe-ar-nft.min.js"></script>
    <style>
      #switchCamera {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 9999;
        padding: 10px;
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid #000;
        border-radius: 5px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <button id="switchCamera" onclick="toggleCamera()">Cambiar Cámara</button>

    <script>
      let currentScene = null;
      
      async function setupScene() {
        // Destruir escena anterior si existe
        if (currentScene) {
          currentScene.parentNode.removeChild(currentScene);
        }
        
        // Obtener parámetro de cámara
        const urlParams = new URLSearchParams(window.location.search);
        const cameraType = urlParams.get('camera');
        const facingMode = cameraType === 'front' ? 'user' : 'environment';
        
        // 1. Listar cámaras disponibles
        try {
          const devices = await navigator.mediaDevices.enumerateDevices();
          const videoDevices = devices.filter(device => device.kind === 'videoinput');
          console.log('Cámaras disponibles:', videoDevices);
        } catch (error) {
          console.error('Error al listar cámaras:', error);
        }

        // 2. Crear nueva escena
        const scene = document.createElement('a-scene');
        scene.innerHTML = `
          <a-assets timeout="10000" id="assets-container"></a-assets>
          <a-camera gps-camera rotation-reader></a-camera>
        `;
        
        // Configurar AR.js con parámetros de cámara
        scene.setAttribute('arjs', `
          sourceType: webcam;
          sourceOptions: {
            video: {
              facingMode: "${facingMode}",
              width: { ideal: 1280 },
              height: { ideal: 720 }
            }
          };
          debugUIEnabled: true;
        `);

        document.body.appendChild(scene);
        currentScene = scene;

        // 3. Verificar constraints reales
        const arjsSys = scene.systems['arjs'];
        arjsSys._arSource.onResize(() => {
          const stream = arjsSys._arSource.stream;
          const track = stream.getVideoTracks()[0];
          console.log('Configuración real de la cámara:', track.getSettings());
        });

        loadModels();
      }

      async function loadModels() {
        try {
          const response = await fetch("models.json");
          const models = await response.json();
          const assetsContainer = document.querySelector("#assets-container");
          const scene = document.querySelector("a-scene");

          models.forEach((item) => {
            const asset = document.createElement("a-asset-item");
            asset.setAttribute("id", item.id);
            asset.setAttribute("src", item.src);
            assetsContainer.appendChild(asset);

            const entity = document.createElement("a-entity");
            entity.setAttribute("gltf-model", `#${item.id}`);
            entity.setAttribute(
              "gps-entity-place",
              `latitude: ${item.latitude}; longitude: ${item.longitude};`
            );
            entity.setAttribute("scale", item.scale);
            scene.appendChild(entity);
          });
        } catch (error) {
          console.error("Error al cargar los modelos:", error);
        }
      }

      function toggleCamera() {
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.has('camera') ? urlParams.delete('camera') : urlParams.set('camera', 'front');
        window.location.search = urlParams.toString();
      }

      document.addEventListener('DOMContentLoaded', setupScene);
    </script>
  </body>
</html>
