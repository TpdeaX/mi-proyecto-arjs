<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ar-js-org/ar.js/aframe/build/aframe-ar-nft.min.js"></script>
    <style>
      #switchCamera {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 9999;
        padding: 10px;
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid #000;
        border-radius: 5px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <button id="switchCamera" onclick="toggleCamera()">Cambiar Cámara</button>

    <script>
      let currentScene = null;
      let arStream = null;

      async function setupScene() {
        if (currentScene) {
          currentScene.parentNode.removeChild(currentScene);
          if (arStream) {
            arStream.getTracks().forEach(track => track.stop());
          }
        }

        const urlParams = new URLSearchParams(window.location.search);
        const cameraType = urlParams.get('camera');
        const facingMode = cameraType === 'front' ? 'user' : 'environment';

        // 1. Listar cámaras disponibles
        try {
          const devices = await navigator.mediaDevices.enumerateDevices();
          const videoDevices = devices.filter(device => device.kind === 'videoinput');
          console.log('Cámaras detectadas:', videoDevices);
        } catch (error) {
          console.error('Error al listar cámaras:', error);
        }

        // 2. Crear nueva escena
        const scene = document.createElement('a-scene');
        scene.setAttribute('embedded', '');
        scene.setAttribute('loading-screen', 'enabled: false;');
        scene.setAttribute('arjs', `
          sourceType: webcam;
          debugUIEnabled: true;
        `);

        // 3. Configuración de cámara
        const camera = document.createElement('a-camera');
        camera.setAttribute('gps-camera', '');
        camera.setAttribute('rotation-reader', '');

        scene.appendChild(camera);
        document.body.appendChild(scene);
        currentScene = scene;

        // 4. Inicializar manualmente la fuente de video
        const arjsSys = scene.systems['arjs'];
        const oldSource = arjsSys._arSource;
        
        try {
          arStream = await navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: { exact: facingMode },
              width: { ideal: 1280 },
              height: { ideal: 720 }
            }
          });
          
          arjsSys._arSource = new THREEx.ArToolkitSource({
            sourceType: 'webcam',
            sourceUrl: arStream
          });
          
          arjsSys._arSource.init(() => {
            arjsSys._arSource.onResize();
            arjsSys._arContext = new THREEx.ArToolkitContext({
              cameraParametersUrl: 'https://arjs-cors-proxy.herokuapp.com/https://raw.githubusercontent.com/AR-js-org/AR.js/master/aframe/data/data/camera_para.dat',
              detectionMode: 'mono'
            });
            arjsSys._arContext.init(() => {
              arjsSys._arContext.arController.setPatternDetectionMode(artoolkit.AR_TEMPLATE_MATCHING_MONO);
            });
          });

          // 5. Verificar configuración real
          const track = arStream.getVideoTracks()[0];
          console.log('Configuración aplicada:', track.getSettings());

        } catch (error) {
          console.error('Error al acceder a la cámara:', error);
        }

        loadModels();
      }

      // ... (loadModels y toggleCamera permanecen iguales)
      async function loadModels() {
        try {
          const response = await fetch("models.json");
          const models = await response.json();
          const assetsContainer = document.querySelector("#assets-container");
          const scene = document.querySelector("a-scene");

          models.forEach((item) => {
            const asset = document.createElement("a-asset-item");
            asset.setAttribute("id", item.id);
            asset.setAttribute("src", item.src);
            assetsContainer.appendChild(asset);

            const entity = document.createElement("a-entity");
            entity.setAttribute("gltf-model", `#${item.id}`);
            entity.setAttribute(
              "gps-entity-place",
              `latitude: ${item.latitude}; longitude: ${item.longitude};`
            );
            entity.setAttribute("scale", item.scale);
            scene.appendChild(entity);
          });
        } catch (error) {
          console.error("Error al cargar los modelos:", error);
        }
      }

      function toggleCamera() {
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.has('camera') ? urlParams.delete('camera') : urlParams.set('camera', 'front');
        window.location.search = urlParams.toString();
      }

      document.addEventListener('DOMContentLoaded', setupScene);
    </script>
  </body>
</html>
