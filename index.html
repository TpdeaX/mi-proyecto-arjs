<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ar-js-org/ar.js/aframe/build/aframe-ar-nft.min.js"></script>
    <style>
      #debug-panel {
        position: fixed;
        top: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 15px;
        border-radius: 5px;
        z-index: 1000;
        max-width: 300px;
      }
    </style>
  </head>
  <body>
    <div id="debug-panel">
      <h3>Estado de carga:</h3>
      <div id="estado-carga">Cargando modelos...</div>
      <h4>Modelos cargados:</h4>
      <ul id="lista-modelos"></ul>
    </div>

    <a-scene
      embedded
      loading-screen="enabled: false;"
      arjs="sourceType: webcam; debugUIEnabled: true;"
    >
      <a-assets timeout="10000" id="assets-container"></a-assets>
      <a-camera gps-camera rotation-reader></a-camera>
      <a-entity position="0 0 -5">
        <a-entity geometry="primitive: cylinder; height: 4; radius: 0.05" 
                  material="color: red"
                  rotation="0 0 -90"></a-entity>
        <a-entity geometry="primitive: cylinder; height: 4; radius: 0.05" 
                  material="color: green"
                  rotation="0 0 0"></a-entity>
        <a-entity geometry="primitive: cylinder; height: 4; radius: 0.05" 
                  material="color: blue"
                  rotation="90 0 0"></a-entity>
      </a-entity>
    </a-scene>

    <script>
      const APP_CONFIG = {
        API_URL: "https://9bf1-179-6-105-29.ngrok-free.app", // Actualizar solo aquí
      };

      async function cargarModelos() {
        try {
          const debugPanel = document.getElementById("estado-carga");
          const listaModelos = document.getElementById("lista-modelos");

          debugPanel.textContent = "Conectando al servidor...";

          const respuesta = await fetch(`${APP_CONFIG.API_URL}/modelos`, {
            mode: "cors",
            headers: {
              "Content-Type": "application/json",
              "ngrok-skip-browser-warning": "true",
            },
            referrerPolicy: "no-referrer",
            credentials: "omit",
          });

          if (!respuesta.ok) throw new Error(`Error HTTP ${respuesta.status}`);

          debugPanel.textContent = "Procesando datos...";
          const modelos = await respuesta.json();

          if (modelos.length === 0) {
            debugPanel.textContent = "No se encontraron modelos";
            return;
          }

          const contenedorAssets = document.querySelector("#assets-container");
          const escena = document.querySelector("a-scene");

          modelos.forEach((modelo) => {
            const li = document.createElement("li");
            li.innerHTML = `
              <strong>${modelo.id}</strong><br>
              Posición: ${modelo.latitud.toFixed(6)}, ${modelo.longitud.toFixed(
              6
            )}<br>
              Escala: ${modelo.escala.x}, ${modelo.escala.y}, ${modelo.escala.z}
            `;
            listaModelos.appendChild(li);

            const asset = document.createElement("a-asset-item");
            asset.setAttribute("id", modelo.id);
            asset.setAttribute("src", modelo.fuente);

            asset.addEventListener("loaded", () => {
              li.style.color = "lightgreen";
              li.innerHTML += "<br>✅ Modelo cargado";
            });

            asset.addEventListener("error", (err) => {
              li.style.color = "red";
              li.innerHTML += "<br>❌ Error cargando modelo";
            });

            contenedorAssets.appendChild(asset);

            const entidad = document.createElement("a-entity");
            entidad.setAttribute("gltf-model", `#${modelo.id}`);
            entidad.setAttribute(
              "gps-entity-place",
              `latitude: ${modelo.latitud}; longitude: ${modelo.longitud};`
            );
            entidad.setAttribute(
              "scale",
              `${modelo.escala.x} ${modelo.escala.y} ${modelo.escala.z}`
            );

            entidad.addEventListener("model-loaded", () => {
              entidad.setAttribute("visible", "true");
              entidad.setAttribute(
                "animation",
                "property: scale; to: 1.1 1.1 1.1; dur: 1000; loop: true"
              );
            });

            escena.appendChild(entidad);
          });

          debugPanel.textContent = "Carga completa";

          setTimeout(() => {
            const entidades = document.querySelectorAll("[gps-entity-place]");
            entidades.forEach((entidad) => {
              if (!entidad.getObject3D("mesh")) {
                console.warn("Entidad sin modelo:", entidad.getAttribute("id"));
              }
            });
          }, 5000);
        } catch (error) {
          document.getElementById(
            "estado-carga"
          ).textContent = `Error: ${error.message}`;
          setTimeout(cargarModelos, 5000);
        }
      }
      cargarModelos();
    </script>
  </body>
</html>
